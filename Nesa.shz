#!/bin/bash

# è‡ªå®šä¹‰æ ·å¼å˜é‡
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
UNDERLINE='\033[4m'
RESET='\033[0m'

# å›¾æ ‡å®šä¹‰
INFO_ICON="â„¹ï¸"
SUCCESS_ICON="âœ…"
WARNING_ICON="âš ï¸"
ERROR_ICON="âŒ"

# æ—¥å¿—æ–‡ä»¶è·¯å¾„
LOG_FILE="$HOME/installation.log"

# ä¿¡æ¯æ˜¾ç¤ºå‡½æ•°
log_info() {
    echo -e "${BLUE}${INFO_ICON} [INFO]${RESET} $1"
    echo "[INFO] $1" >> "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}${SUCCESS_ICON} [SUCCESS]${RESET} $1"
    echo "[SUCCESS] $1" >> "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}${WARNING_ICON} [WARNING]${RESET} $1"
    echo "[WARNING] $1" >> "$LOG_FILE"
}

log_error() {
    echo -e "${RED}${ERROR_ICON} [ERROR]${RESET} $1"
    echo "[ERROR] $1" >> "$LOG_FILE"
}

# è„šæœ¬ä¿å­˜è·¯å¾„
SCRIPT_PATH="$HOME/Nesa.sh"

# ä¸»èœå•å‡½æ•°
function main_menu() {
    while true; do
        clear
        # ä¸‹è½½å¹¶æ˜¾ç¤º logo
        curl -s https://raw.githubusercontent.com/ziqing888/logo.sh/refs/heads/main/logo.sh | bash
        sleep 3
        echo -e "${CYAN}${BOLD}============================================${RESET}"
        echo -e "${CYAN}${BOLD}         ğŸš€ æ¬¢è¿ä½¿ç”¨èŠ‚ç‚¹ç®¡ç†è„šæœ¬ ğŸš€       ${RESET}"
        echo -e "${CYAN}${BOLD}============================================${RESET}"
        echo "è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ:"
        echo "1) å®‰è£…èŠ‚ç‚¹"
        echo "2) è·å–èŠ‚ç‚¹çŠ¶æ€ URL"
        echo "3) è·å–èŠ‚ç‚¹ä¿¡æ¯ï¼ˆç§é’¥ï¼‰"
        echo "4) é€€å‡º"
        read -p "è¯·è¾“å…¥é€‰é¡¹ [1-4]: " choice

        case $choice in
            1) install_node ;;
            2) get_node_status_url ;;
            3) get_node_info ;;
            4)
                log_info "é€€å‡ºè„šæœ¬ã€‚"
                exit 0
                ;;
            *)
                log_warning "æ— æ•ˆçš„é€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚"
                ;;
        esac
    done
}

# è·å–èŠ‚ç‚¹çŠ¶æ€ URL å‡½æ•°
function get_node_status_url() {
    if [ -f "$HOME/.nesa/identity/node_id.id" ]; then
        PUB_KEY=$(cat $HOME/.nesa/identity/node_id.id)
        log_info "èŠ‚ç‚¹çŠ¶æ€ URL: https://node.nesa.ai/nodes/$PUB_KEY"
    else
        log_error "èŠ‚ç‚¹èº«ä»½æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·ç¡®è®¤ $HOME/.nesa/identity/node_id.id æ˜¯å¦å­˜åœ¨ã€‚"
    fi
    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

# è·å–èŠ‚ç‚¹ä¿¡æ¯å‡½æ•°
function get_node_info() {
    ENV_FILE="$HOME/.nesa/env/agent.env"
    if [ -f "$ENV_FILE" ]; then
        log_info "è·å–èŠ‚ç‚¹ä¿¡æ¯:"
        echo "========================================"
        grep '^LETSENCRYPT_EMAIL=' $ENV_FILE | cut -d '=' -f2
        grep '^NODE_HOSTNAME=' $ENV_FILE | cut -d '=' -f2
        grep '^NODE_PRIV_KEY=' $ENV_FILE | cut -d '=' -f2
    else
        log_error "ç¯å¢ƒæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·ç¡®è®¤ $ENV_FILE æ˜¯å¦å­˜åœ¨ã€‚"
    fi
    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

# å®‰è£…èŠ‚ç‚¹å‡½æ•°
function install_node() {
    log_info "æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£… curl..."
    sudo apt-get update
    sudo apt-get install -y curl

    # æ£€æµ‹ Docker æ˜¯å¦å®‰è£…
    if ! command -v docker &> /dev/null; then
        log_info "Docker æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£… Docker..."
        
        # æ·»åŠ  Docker çš„ GPG å¯†é’¥
        log_info "æ·»åŠ  Docker çš„ GPG å¯†é’¥..."
        sudo apt-get update
        sudo apt-get install -y ca-certificates curl
        sudo install -m 0755 -d /etc/apt/keyrings
        sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        sudo chmod a+r /etc/apt/keyrings/docker.asc

        # å°† Docker ä»“åº“æ·»åŠ åˆ° APT æºä¸­
        log_info "æ·»åŠ  Docker ä»“åº“..."
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
          $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
          sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

        # å¯åŠ¨ Docker æœåŠ¡
        log_info "å¯åŠ¨ Docker æœåŠ¡..."
        sudo systemctl start docker
        sudo systemctl enable docker
    else
        log_info "Docker å·²å®‰è£…ã€‚"
    fi

    # æ·»åŠ ç”¨æˆ·åˆ° Docker ç»„
    if ! getent group docker > /dev/null; then
        log_info "åˆ›å»º Docker ç»„..."
        sudo groupadd docker
    fi

    log_info "å°†ç”¨æˆ· $USER æ·»åŠ åˆ° Docker ç»„..."
    sudo usermod -aG docker $USER
    
    # æ£€æµ‹ NVIDIA GPU é©±åŠ¨æ˜¯å¦å®‰è£…
    if ! command -v nvidia-smi &> /dev/null; then
        log_info "NVIDIA é©±åŠ¨æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ NVIDIA é©±åŠ¨ã€‚"
        sudo add-apt-repository ppa:graphics-drivers/ppa
        sudo apt-get update
        sudo apt-get install -y nvidia-driver-$(ubuntu-drivers devices | grep recommended | awk '{print $3}')
    else
        log_info "NVIDIA é©±åŠ¨å·²å®‰è£…ã€‚"
    fi

    # å®‰è£… gumï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if ! command -v gum &> /dev/null; then
        log_info "gum æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£… gumã€‚"
        curl -fsSL https://github.com/charmbracelet/gum/releases/download/v0.18.0/gum_0.18.0_linux_amd64.tar.gz | sudo tar xz -C /usr/local/bin
    else
        log_info "gum å·²å®‰è£…ã€‚"
    fi

    # å®‰è£… jqï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if ! command -v jq &> /dev/null; then
        log_info "jq æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£… jqã€‚"
        sudo apt-get install -y jq
    else
        log_info "jq å·²å®‰è£…ã€‚"
    fi

    # æ£€æµ‹ Docker Compose æ˜¯å¦å®‰è£…
    if ! command -v docker-compose &> /dev/null; then
        log_info "Docker Compose æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£… Docker Composeã€‚"
        VER=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep tag_name | cut -d '"' -f 4)
        curl -L "https://github.com/docker/compose/releases/download/$VER/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
    else
        log_info "Docker Compose å·²å®‰è£…ã€‚"
    fi

    # éªŒè¯å®‰è£…
    docker-compose --version

    # é…ç½®èŠ‚ç‚¹
    log_info "é…ç½®èŠ‚ç‚¹..."
    read -p "è¯·ä¸ºæ‚¨çš„èŠ‚ç‚¹é€‰æ‹©ä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼š " NODE_NAME
    PS3="è¯·é€‰æ‹©èŠ‚ç‚¹ç±»å‹: "
    NODE_TYPE_OPTIONS=("Validator" "Miner" "é€€å‡º")
    select NODE_TYPE in "${NODE_TYPE_OPTIONS[@]}"; do
        case $NODE_TYPE in
            "Validator")
                read -p "Validator's Private Key: " PRIVATE_KEY
                log_info "èŠ‚ç‚¹åç§°: $NODE_NAME"
                log_info "èŠ‚ç‚¹ç±»å‹: Validator"
                log_info "Validator's Private Key: $PRIVATE_KEY"
                break
                ;;
            "Miner")
                PS3="è¯·é€‰æ‹©çŸ¿å·¥ç±»å‹: "
                MINER_TYPE_OPTIONS=("Distributed Miner" "Non-Distributed Miner" "é€€å‡º")
                select MINER_TYPE in "${MINER_TYPE_OPTIONS[@]}"; do
                    case $MINER_TYPE in
                        "Distributed Miner")
                            PS3="è¯·é€‰æ‹© swarm æ“ä½œ: "
                            SWARM_ACTION_OPTIONS=("Join existing swarm" "Start a new swarm" "é€€å‡º")
                            select SWARM_ACTION in "${SWARM_ACTION_OPTIONS[@]}"; do
                                case $SWARM_ACTION in
                                    "Start a new swarm")
                                        read -p "Which model would you like to run? (meta-llama/Llama-2-13b-Chat-Hf): " MODEL
                                        log_info "èŠ‚ç‚¹åç§°: $NODE_NAME"
                                        log_info "èŠ‚ç‚¹ç±»å‹: Miner"
                                        log_info "çŸ¿å·¥ç±»å‹: Distributed Miner"
                                        log_info "Swarm æ“ä½œ: Start a new swarm"
                                        log_info "æ¨¡å‹: $MODEL"
                                        break
                                        ;;
                                    "Join existing swarm")
                                        log_info "åŠ å…¥ç°æœ‰ swarm çš„é€»è¾‘å°šæœªå®ç°ã€‚"
                                        log_info "èŠ‚ç‚¹åç§°: $NODE_NAME"
                                        log_info "èŠ‚ç‚¹ç±»å‹: Miner"
                                        log_info "çŸ¿å·¥ç±»å‹: Distributed Miner"
                                        log_info "Swarm æ“ä½œ: Join existing swarm"
                                        break
                                        ;;
                                    "é€€å‡º")
                                        exit 1
                                        ;;
                                    *)
                                        log_warning "æ— æ•ˆçš„é€‰é¡¹ $REPLY"
                                        ;;
                                esac
                            done
                            break
                            ;;
                        "Non-Distributed Miner")
                            read -p "Which model would you like to run? (meta-llama/Llama-2-13b-Chat-Hf): " MODEL
                            log_info "èŠ‚ç‚¹åç§°: $NODE_NAME"
                            log_info "èŠ‚ç‚¹ç±»å‹: Miner"
                            log_info "çŸ¿å·¥ç±»å‹: Non-Distributed Miner"
                            log_info "æ¨¡å‹: $MODEL"
                            break
                            ;;
                        "é€€å‡º")
                            exit 1
                            ;;
                        *)
                            log_warning "æ— æ•ˆçš„é€‰é¡¹ $REPLY"
                            ;;
                    esac
                done
                break
                ;;
            "é€€å‡º")
                exit 1
                ;;
            *)
                log_warning "æ— æ•ˆçš„é€‰é¡¹ $REPLY"
                ;;
        esac
    done

    log_info "è¿è¡Œè¿œç¨‹åˆå§‹åŒ–è„šæœ¬..."
    bash <(curl -s https://raw.githubusercontent.com/nesaorg/bootstrap/master/bootstrap.sh)

    log_info "å°è¯•å¯åŠ¨ Docker Compose å®¹å™¨..."
    cd /root/.nesa/docker
    if sudo docker-compose up -d; then
        log_success "Docker Compose å®¹å™¨å¯åŠ¨æˆåŠŸã€‚"
    else
        log_error "Docker Compose å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œæ—¥å¿—ã€‚"
    fi
    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

# è¿è¡Œä¸»èœå•
main_menu
